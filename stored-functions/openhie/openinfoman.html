<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="urn:ihe:iti:csd:2013" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:csd="urn:ihe:iti:csd:2013" xmlns:xforms="http://www.w3.org/2002/xforms">
  <head>
    <style type="text/css">
          div {
          border-radius: 1em 1em 1em 1em;
          }
          .function {
          background-color: #feedff;
          width:90%;
          magin-top:2em;
          padding-bottom:1em;
          padding-left:1em;
	  box-shadow:0 6px 2px 0 #CCCCCC;
          }
	  .source {
	  overflow:auto;
	  }
          .attribute{
          border-radius: 1em 1em 1em 1em;
          background-color: #FBFBEF;                    
          font-style: italic;
          font-weight: lighter;
          height: auto;
          float:right;
          margin-right:2em;
          margin-left: 1em;
          padding: 2em;
	  box-shadow:0 4px 2px 0 #CCCCCC;
          }
          .callout{
          background: none repeat scroll 0 0 #EEEEEE;
          margin: 1em;
          overflow: auto;
          padding: 1em 2em;
          width: auto;
	  box-shadow:0 6px 2px 0 #CCCCCC;
          }
          .callout h2 {
          background-color: #EEFFFF;
          border-radius: 0.5em 0.5em 0.5em 0.5em;
          padding: 0.2em 0.2em 0.2em 1em;
          }
          pre {
          font-family: "Courier New",Courier,monospace;
          font-size: 0.8em;
	  overflow:scroll;
          }
	  li i.urn {
	  display:inline-block;
	  min-width:18em;
	  max-width:18em;
	  width:18em;
	  }
        </style>
  </head>
  <body>
    <div class="function">
      <h2>Stored Functions</h2>
      <ul>
        <li>
          <i class="urn">urn:ihe:iti:csd:2014:adhoc</i>
          <a style="position:relative;left:2em" href="#urn:ihe:iti:csd:2014:adhoc"> 
    Performs an ad-hoc search on a CSD document
  </a>
        </li>
        <li>
          <i class="urn">urn:ihe:iti:csd:2014:stored-function:facility-search</i>
          <a style="position:relative;left:2em" href="#urn:ihe:iti:csd:2014:stored-function:facility-search"> 
    
    Performs a search for all facilities by name, type, address or ID.   
    
    
      The...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:modtimes</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:modtimes"> 
    Gets the maximum modification times for each of the four directories
  </a>
        </li>
        <li>
          <i class="urn">urn:ihe:iti:csd:2014:stored-function:organization-search</i>
          <a style="position:relative;left:2em" href="#urn:ihe:iti:csd:2014:stored-function:organization-search"> 
    
    Performs a search for all organizations by name, coded type, address or ID.   
    
    
...</a>
        </li>
        <li>
          <i class="urn">urn:ihe:iti:csd:2014:stored-function:provider-search</i>
          <a style="position:relative;left:2em" href="#urn:ihe:iti:csd:2014:stored-function:provider-search">
     Performs a search for all providers by name, coded type, address or ID. 
     The result set c...</a>
        </li>
        <li>
          <i class="urn">urn:ihe:iti:csd:2014:stored-function:service-search</i>
          <a style="position:relative;left:2em" href="#urn:ihe:iti:csd:2014:stored-function:service-search"> 
    
    Performs a search for all search by coded type or ID.   
    
    
      The result set c...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:delete_duplicate</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:delete_duplicate"> 
    Deletes duplicate record reference.  This is done by removing a &lt;csd:otherID/&gt; element on the ...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:delete_potential_duplicate</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:delete_potential_duplicate"> 
    Deletes potential duplicate record reference.  This is done by removing a &lt;csd:otherID/&gt; eleme...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:extract_hierachy</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:extract_hierachy"> 
    Performs an organization hierarch extraction from a source document into the target document. ...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:facility_create</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:facility_create">Create or update a facility entity.   Request parameters should be one or more CSD facility entities</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:mark_duplicate</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:mark_duplicate"> 
    Marks a record as a duplicate with another record.  This is done by adding a &lt;csd:otherID/&gt; el...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:mark_potential_duplicate</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:mark_potential_duplicate"> 
    Marks a record as a potential duplicate with another record.  This is done by adding a &lt;csd:ot...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:identifier_merge</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:identifier_merge"> 
    Performs a merge from the indicated source document(s) into the target document.   Any entitie...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:organization_create</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:organization_create">Create or update a organization entity.   Request parameters should be one or more CSD organization ...</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:provider_create</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:provider_create">Create or update a provider entity.   Request parameters should be one or more CSD provider entities</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:service_create</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:service_create">Create or update a service entity.   Request parameters should be one or more CSD service entities</a>
        </li>
        <li>
          <i class="urn">urn:openhie.org:openinfoman:simple_merge</i>
          <a style="position:relative;left:2em" href="#urn:openhie.org:openinfoman:simple_merge"> 
    Performs a simple merge from the indicated source document(s) into the target document.  

   ...</a>
        </li>
      </ul>
    </div>
    <a id="urn:ihe:iti:csd:2014:adhoc"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:ihe:iti:csd:2014:adhoc</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Performs an ad-hoc search on a CSD document
  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
declare namespace csd  =  "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;


let $expr :=$careServicesRequest/adhoc/text()

return 
  if ($expr) 
  then xquery:eval($expr,map{"":/.})
  else ()
</pre></span>
      </div>
    </div>
    <a id="urn:ihe:iti:csd:2014:stored-function:facility-search"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:ihe:iti:csd:2014:stored-function:facility-search</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    
    Performs a search for all facilities by name, type, address or ID.   
    
    
      The result set consists of all facilities matching the  search parameters ( id, primaryName, name, codedType and address ).
     
        
      The results set may be further restricted according to the limit parameters (start, max, record/@status and record/@updated).  An ordering of the result set is not specified.
    
    
    Response
    Results are returned as a valid CSD document with a root document element of &lt;CSD/&gt;.  The results set is contained entirely within the &lt;facilityDirectory/&gt; element and consists of the full content of the &lt;facility/&gt; elements of matching facilities as maintained by the Care Services InfoManager.
    
    Parameters Query
    Parameters are defined as the content of following elements:
    
       &lt;id/&gt; csd:uniqueID: (optional) If present and the @entityID attribute contains a non-empty value, it is a ID which uniquely identifies a facility. This is an exact match.  
      
      &lt;primaryName/&gt; xs:string: (optional) If present and contains a non-empty value, then the result set should be restricted to those facilities whose &lt;primaryName/&gt; contains this value. Case insensitive.
      &lt;name/&gt; xs:string: (optional) If present and contains a non-empty value, then the result set should be restricted to those facilities which have a &lt;primaryName/&gt; or &lt;otherName/&gt; element containing this value. Case insensitive.      
      &lt;codedType/&gt; csd:codedtype:  If present and contains a non-empty value the result set should be restricted to those facilities whose &lt;codedType/@code&gt; equals this value for the coding schema specified by the @codingScheme attribute.  Case insensitive.
      
       &lt;address/&gt; csd:address: (optional) Contains of any-number of child &lt;addressLine/&gt; elements as follows:
        
          Text content xs:string: (optional) If present and contains a non-empty value, then the results set should be restricted to those facilities whose have an &lt;addressLine/&gt; with specified @component containing this value exactly.  Case insensitive.
           
          @component xs:string : (Required attribute) The component of the address we are searching. Case insensitive.
          
      
      &lt;start/&gt;  xs:int: (optional) The starting index for results returned. Defaults to 1, which indexes the first facility matching the search parameters
      &lt;max/&gt;  xs:int: (optional) The maximum number of results returned.  A value of less than zero implies no maximum.
      
	&lt;record/&gt;  csd:record : (optional) A child element to limit results according to
	
	  @status xs:string: (optional) If present and contains a non-empty value, the result set should be restricted to those facilities whose record/@status equals this value.  Case insensitive.
	  @updated xs:dateTime: (optional) If present and contains a non-empty value, the result set should be restricted to those facilities whose record/@updated is at least the given value.
	
      
    
    Example Request
    
         &lt;careServicesRequest&gt;
           &lt;function urn='urn:ihe:iti:csd:2014:stored-function:facility-search'&gt;
               &lt;codedType code='OPC' codingScheme="USDVA"/&gt;
               &lt;address&gt;
                 &lt;addressLine component='city'&gt;Chapel Hill&lt;/addressLine&gt;
	       &lt;/address&gt;
               &lt;max&gt;5&lt;/max&gt;
           &lt;/function&gt;
         &lt;/careServicesRequest&gt;         
      
  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare  variable $careServicesRequest as item() external;



(: 
   The query will be executed against the root element of the CSD document.
    
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 
&lt;CSD xmlns:csd="urn:ihe:iti:csd:2013"  &gt;
  &lt;organizationDirectory/&gt;
  &lt;serviceDirectory/&gt;
  &lt;facilityDirectory&gt;
    {
      let $facs0 := if (exists($careServicesRequest/id))
	then csd_bl:filter_by_primary_id(/CSD/facilityDirectory/*,$careServicesRequest/id)
      else /CSD/facilityDirectory/*
         
      let $facs1 := if (exists($careServicesRequest/primaryName))
	then csd_bl:filter_by_primary_name($facs0,$careServicesRequest/primaryName)
      else $facs0
         
      let $facs2 := if (exists($careServicesRequest/name))
	then csd_bl:filter_by_name($facs1,$careServicesRequest/name)
      else $facs1
    
      let $facs3 := if(exists($careServicesRequest/codedType))
	then csd_bl:filter_by_coded_type($facs2,$careServicesRequest/codedType) 
      else $facs2
   
      let $facs4 := if(exists($careServicesRequest/address/addressLine))
	then csd_bl:filter_by_address($facs3, $careServicesRequest/address/addressLine) 
      else $facs3

      let $facs5 := if (exists($careServicesRequest/record))
	then csd_bl:filter_by_record($facs4,$careServicesRequest/record)      
      else $facs4

      let $facs6 := if(exists($careServicesRequest/otherID))
	then csd_bl:filter_by_other_id($facs5,$careServicesRequest/otherID)      
      else $facs5


      let $facs7 :=  if (exists($careServicesRequest/organizations/organization)) 
	then (csd_bl:filter_by_organizations($facs6,$careServicesRequest/organizations/organization)      )
      else  ($facs6)
	

      return if (exists($careServicesRequest/start)) then
	if (exists($careServicesRequest/max)) 
	  then csd_bl:limit_items($facs7,$careServicesRequest/start,$careServicesRequest/max)         
	else csd_bl:limit_items($facs7,$careServicesRequest/start,&lt;max/&gt;)         
      else
	if (exists($careServicesRequest/max)) 
	  then csd_bl:limit_items($facs7,&lt;start/&gt;,$careServicesRequest/max)         
	else $facs7


    }     
  &lt;/facilityDirectory&gt;
  &lt;providerDirectory/&gt;
&lt;/CSD&gt;
    </pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:modtimes"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:modtimes</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Gets the maximum modification times for each of the four directories
  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>declare namespace csd = 'urn:ihe:iti:csd:2013';
declare variable $careServicesRequest as item() external;
let $ptime := max( for $dt in /csd:CSD/csd:providerDirectory/csd:provider/csd:record/@updated return xs:dateTime($dt))
let $otime := max( for $dt in /csd:CSD/csd:organizationDirectory/csd:provider/csd:record/@updated return xs:dateTime($dt))
let $ftime := max( for $dt in /csd:CSD/csd:facilityDirectory/csd:provider/csd:record/@updated return xs:dateTime($dt))
let $stime := max( for $dt in /csd:CSD/csd:serviceDirectory/csd:provider/csd:record/@updated return xs:dateTime($dt))
let $time := max (($ptime,$otime,$ftime,$stime))
return 
  &lt;csd:CSD updated="{$time}"&gt;
    &lt;csd:providerDirectory updated="{$ptime}"/&gt;
    &lt;csd:facilityDirectory updated="{$ftime}"/&gt;
    &lt;csd:organizationDirectory updated="{$otime}"/&gt;
    &lt;csd:serviceDirectory updated="{$stime}"/&gt;
  &lt;/csd:CSD&gt;</pre></span>
      </div>
    </div>
    <a id="urn:ihe:iti:csd:2014:stored-function:organization-search"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:ihe:iti:csd:2014:stored-function:organization-search</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    
    Performs a search for all organizations by name, coded type, address or ID.   
    
    
      The result set consists of all organizations matching the  search parameters ( id, primaryName, name, codedType and address ).
     
        
      The results set may be further restricted according to the limit parameters (start, max, record/@status and record/@updated).  An ordering of the result set is not specified.
    
    
    Response
    Results are returned as a valid CSD document with a root document element of &lt;CSD/&gt;.  The results set is contained entirely within the &lt;organizationDirectory/&gt; element and consists of the full content of the &lt;organization/&gt; elements of matching organizations as maintained by the Care Services InfoManager.
    
    Parameters Query
    Parameters are defined as the content of following elements:
    
       &lt;id/&gt; csd:uniqueID: (optional) If present and the @entityID attribute contains a non-empty value, it is a ID which uniquely identifies an organization. This is an exact match.  
      
      &lt;primaryName/&gt; xs:string: (optional) If present and contains a non-empty value, then the result set should be restricted to those organizations whose &lt;primaryName/&gt; contains this value. Case insensitive.
      &lt;name/&gt; xs:string: (optional) If present and contains a non-empty value, then the result set should be restricted to those organizations which have a &lt;primaryName/&gt; or &lt;otherName/&gt; element containing this value. Case insensitive.      
      &lt;codedType/&gt; csd:codedtype:  If present and contains a non-empty value the result set should be restricted to those organizations whose &lt;codedType/@code&gt; equals this value for the coding schema specified by the @codingScheme attribute.  Case insensitive.
      
       &lt;address/&gt; csd:address: (optional) Contains of any-number of child &lt;addressLine/&gt; elements as follows:
        
          Text content xs:string: (optional) If present and contains a non-empty value, then the results set should be restricted to those organizations whose have an &lt;addressLine/&gt; with specified @component containing this value exactly.  Case insensitive.
           
          @component xs:string : (Required attribute) The component of the address we are searching. Case insensitive.
          
      
      &lt;start/&gt;  xs:int: (optional) The starting index for results returned. Defaults to 1, which indexes the first organization matching the search parameters
      &lt;max/&gt;  xs:int: (optional) The maximum number of results returned.  A value of less than zero implies no maximum.
      
	&lt;record/&gt;  csd:record : (optional) A child element to limit results according to
	
	  @status xs:string: (optional) If present and contains a non-empty value, the result set should be restricted to those organizations whose record/@status equals this value.  Case insensitive.
	  @updated xs:dateTime: (optional) If present and contains a non-empty value, the result set should be restricted to those organizations whose record/@updated is at least the given value.
	
      
    
    Example Request
    
         &lt;careServicesRequest&gt;
           &lt;function urn='urn:ihe:iti:csd:2014:stored-function:service-search'&gt;
               &lt;codedType codingScheme="moh.gov.rw" code="FBO" /&gt;
               &lt;address&gt;
                 &lt;addressLine component='city'&gt;Kigali&lt;/addressLine&gt;
	       &lt;/address&gt;
               &lt;max&gt;5&lt;/max&gt;
           &lt;/function&gt;
         &lt;/careServicesRequest&gt;         
      
  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;

(: 
   The query will be executed against the root element of the CSD document.
    
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 


&lt;CSD xmlns:csd="urn:ihe:iti:csd:2013"  &gt;
  &lt;organizationDirectory&gt;
    {
      let $orgs0 := if (exists($careServicesRequest/id))
	then csd_bl:filter_by_primary_id(/CSD/organizationDirectory/*,$careServicesRequest/id)
      else /CSD/organizationDirectory/*
         
      let $orgs1 := if (exists($careServicesRequest/primaryName))
	then csd_bl:filter_by_primary_name($orgs0,$careServicesRequest/primaryName)
      else $orgs0
         
      let $orgs2 := if(exists($careServicesRequest/name))
	then csd_bl:filter_by_name($orgs1,$careServicesRequest/name)
      else $orgs1
    
      let $orgs3 := if(exists($careServicesRequest/codedType))
	then csd_bl:filter_by_coded_type($orgs2,$careServicesRequest/codedType)
      else $orgs2
   
      let $orgs4 :=if (exists($careServicesRequest/address/addressLine))
	then csd_bl:filter_by_address($orgs3, $careServicesRequest/address/addressLine)
      else $orgs3
      
      let $orgs5 := if (exists($careServicesRequest/record))
	then csd_bl:filter_by_record($orgs4,$careServicesRequest/record)
      else $orgs4

      let $orgs6 := if (exists($careServicesRequest/otherID))
	then csd_bl:filter_by_other_id($orgs5,$careServicesRequest/otherID)
      else $orgs5

      let $orgs7 := if (exists($careServicesRequest/parent))
	then csd_bl:filter_by_parent($orgs5,$careServicesRequest/parent)
      else $orgs6

      return if (exists($careServicesRequest/start)) then
	if (exists($careServicesRequest/max))
	  then csd_bl:limit_items($orgs7,$careServicesRequest/start,$careServicesRequest/max)
	else csd_bl:limit_items($orgs7,$careServicesRequest/start,&lt;max/&gt;)
      else
	if (exists($careServicesRequest/max))
	  then csd_bl:limit_items($orgs7,&lt;start/&gt;,$careServicesRequest/max)
	else $orgs7

    }     
  &lt;/organizationDirectory&gt;
  &lt;serviceDirectory/&gt;
  &lt;facilityDirectory/&gt;
  &lt;providerDirectory/&gt;
&lt;/CSD&gt;
</pre></span>
      </div>
    </div>
    <a id="urn:ihe:iti:csd:2014:stored-function:provider-search"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:ihe:iti:csd:2014:stored-function:provider-search</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source">
     Performs a search for all providers by name, coded type, address or ID. 
     The result set consists of all providers matching the search parameters ( id,
        otherID, commonName,codedType and address ). 
     The results set may be further restricted according to the limit parameters
        (start, max, record/@status and record/@updated). An ordering of
      the result set is not specified. 
    
      Response Results are returned as a valid CSD document with a root document element of
      &lt;CSD/&gt;. The results set is contained entirely within the &lt;providerDirectory/&gt;
      element and consists of the full content of the &lt;provider/&gt; elements of matching
      providers as maintained by the Care Services InfoManager. 
    Parameters Query Parameters are defined as the content of following elements: 
       &lt;id/&gt; csd:uniqueID: (optional) If present and the @entityID attribute contains a
        non-empty value, it is a ID which uniquely identifies a provider. This is an exact match. 
       &lt;otherID/&gt; csd:otherID: (optional) If present and the
        @assigningAuthorityName attribute contains a non-empty value, then the result set is
        restricted to only those providers which have a &lt;otherID/&gt; with the given
        assigingAuthorityName and @code  &lt;commonName/&gt; xsd:string: (optional)
        If present and contains a non-empty value, then the result set should be restricted to those
        providers which have a &lt;demographic/name/commonName/&gt; containing this value. Case
        insensitive.
      &lt;codedType/&gt; csd:codedtype: If present and contains a non-empty value the
        result set should be restricted to those providers whose &lt;codeType/@code&gt; equals this
        value for the coding schema specified by the @codingScheme attribute. Case insensitive. 
       &lt;address/&gt; csd:address: (optional) Contains of any-number of child
        &lt;addressLine/&gt; elements as follows: 
          Text content xsd:string: (optional) If present and contains a non-empty value,
            then the results set should be restricted to those providers whose have an
            &lt;addressLine/&gt; with specified @component containing this value exactly. Case
            insensitive. 
          @component xsd:string : (Required attribute) The component of the address we
            are searching. Case insensitive.
        
      
      &lt;start/&gt;  xsd:int: (optional) The starting index for results returned.
        Defaults to 1, which indexes the first provider matching the search parameters
      &lt;max/&gt;  xsd:int: (optional) The maximum number of results returned. A value
        of less than zero implies no maximum.
       &lt;record/&gt;  csd:record : (optional) A child element to limit results
        according to 
          @status xsd:string: (optional) If present and contains a non-empty value, the
            result set should be restricted to those providers whose record/@status equals this
            value. Case insensitive.
          @updated xsd:dateTime: (optional) If present and contains a non-empty value,
            the result set should be restricted to those providers whose record/@updated is at least
            the given value.
        
      
    
    Example Request
    
         &lt;careServicesRequest&gt;
           &lt;function urn='urn:ihe:iti:csd:2014:stored-function:service-search'&gt;
               &lt;codedType code="2221" codingScheme="ISCO-08" /&lt;
               &lt;address&gt;
                 &lt;addressLine component='city'&gt;Kigali&lt;/addressLine&gt;
	       &lt;/address&gt;
               &lt;max&gt;5&lt;/max&gt;
           &lt;/function&gt;
         &lt;/careServicesRequest&gt;         
      
  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;

(: 
   The query will be executed against the root element of the CSD document.
    
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 

&lt;CSD xmlns:csd="urn:ihe:iti:csd:2013"  &gt;
  &lt;organizationDirectory/&gt;
  &lt;serviceDirectory/&gt;
  &lt;facilityDirectory/&gt;
  &lt;providerDirectory&gt;
    {

      let $provs0 := if (exists($careServicesRequest/id))
	then csd_bl:filter_by_primary_id(/CSD/providerDirectory/*,$careServicesRequest/id)
      else /CSD/providerDirectory/*

      let $provs1 := if(exists($careServicesRequest/otherID))
	then csd_bl:filter_by_other_id($provs0,$careServicesRequest/otherID)
      else $provs0
         
      let $provs2 := if(exists($careServicesRequest/commonName))
	then csd_bl:filter_by_common_name($provs1,$careServicesRequest/commonName)
      else $provs1
    
      let $provs3 := if (exists($careServicesRequest/codedType))
	then csd_bl:filter_by_coded_type($provs2,$careServicesRequest/codedType) 
      else $provs2
   
      let $provs4 := if (exists($careServicesRequest/address/addressLine))
	then csd_bl:filter_by_demographic_address($provs3, $careServicesRequest/address/addressLine) 
      else $provs3

      let $provs5 :=  if (exists($careServicesRequest/record)) 
	then csd_bl:filter_by_record($provs4,$careServicesRequest/record)      
      else  $provs4

      let $provs6 :=  if (exists($careServicesRequest/facilities/facility)) 
	then csd_bl:filter_by_facilities($provs5,$careServicesRequest/facilities/facility)
      else  $provs5

      let $provs7 :=  if (exists($careServicesRequest/organizations/organization)) 
	then csd_bl:filter_by_organizations($provs6,$careServicesRequest/organizations/organization)      
      else  $provs6

      let $provs7a := if(exists($careServicesRequest/language))
	then csd_bl:filter_by_languages($provs7,$careServicesRequest/language)
      else $provs7
    


      return if (exists($careServicesRequest/start)) then
	if (exists($careServicesRequest/max)) 
	  then csd_bl:limit_items($provs7a,$careServicesRequest/start,$careServicesRequest/max)         
	else csd_bl:limit_items($provs7a,$careServicesRequest/start,&lt;max/&gt;)         
      else
	if (exists($careServicesRequest/max)) 
	  then csd_bl:limit_items($provs7a,&lt;start/&gt;,$careServicesRequest/max)         
	else $provs7a

    }     
  &lt;/providerDirectory&gt;
&lt;/CSD&gt;
</pre></span>
      </div>
    </div>
    <a id="urn:ihe:iti:csd:2014:stored-function:service-search"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:ihe:iti:csd:2014:stored-function:service-search</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    
    Performs a search for all search by coded type or ID.   
    
    
      The result set consists of all serices matching the  search parameters ( id and codedType ).
     
        
      The results set may be further restricted according to the limit parameters (start, max, record/@status and record/@updated).  An ordering of the result set is not specified.
    
    
    Response
    Results are returned as a valid CSD document with a root document element of &lt;CSD/&gt;.  The results set is contained entirely within the &lt;serviceDirectory/&gt; element and consists of the full content of the &lt;service/&gt; elements of matching services as maintained by the Care Services InfoManager.
    
    Parameters Query
    Parameters are defined as the content of following elements:
    
       &lt;id/&gt; csd:uniqueID: (optional) If present and the @entityID attribute contains a non-empty value, it is a ID which uniquely identifies a service. This is an exact match.  
      
      &lt;codedType/&gt; csd:codedtype:  If present and contains a non-empty value the result set should be restricted to those services whose &lt;codedType/@code&gt; equals this value for the coding schema specified by the @codingScheme attribute.  Case insensitive.
      
      &lt;start/&gt;  xs:int: (optional) The starting index for results returned. Defaults to 1, which indexes the first service matching the search parameters
      &lt;max/&gt;  xs:int: (optional) The maximum number of results returned.  A value of less than zero implies no maximum.
      
	&lt;record/&gt;  csd:record : (optional) A child element to limit results according to
	
	  @status xs:string: (optional) If present and contains a non-empty value, the result set should be restricted to those serivces whose record/@status equals this value.  Case insensitive.
	  @updatedxs:dateTime: (optional) If present and contains a non-empty value, the result set should be restricted to those serivces whose record/@updated is at least the given value.
	
      
    
    Example Request
    
         &lt;careServicesRequest&gt;
           &lt;function urn='urn:ihe:iti:csd:2014:stored-function:service-search'&gt;
             &lt;codedType code="76499" codingScheme="HCPCS" /&gt;
             &lt;start&gt;101&lt;/max&gt;
           &lt;/function&gt;
         &lt;/careServicesRequest&gt;         
      
  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;

(: 
   The query will be executed against the root element of the CSD document.
    
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 

&lt;CSD xmlns:csd="urn:ihe:iti:csd:2013"  &gt;
  &lt;organizationDirectory/&gt;
  &lt;serviceDirectory&gt;
    {
      let $svcs0 := if (exists($careServicesRequest/id))
	then csd_bl:filter_by_primary_id(/CSD/serviceDirectory/*,$careServicesRequest/id)
      else /CSD/serviceDirectory/*
    	
      let $svcs1 := if(exists($careServicesRequest/codedType))
	then csd_bl:filter_by_coded_type($svcs0,$careServicesRequest/codedType) 
      else $svcs0

      let $svcs2 :=  if (exists($careServicesRequest/record))
	then csd_bl:filter_by_record($svcs1,$careServicesRequest/record)
      else $svcs1

      return if (exists($careServicesRequest/start)) then
	if (exists($careServicesRequest/max)) 
	  then csd_bl:limit_items($svcs2,$careServicesRequest/start,$careServicesRequest/max)         
	else csd_bl:limit_items($svcs2,$careServicesRequest/start,&lt;max/&gt;)         
      else
	if (exists($careServicesRequest/max)) 
	  then csd_bl:limit_items($svcs2,&lt;start/&gt;,$careServicesRequest/max)         
	else $svcs2

    }     
  &lt;/serviceDirectory&gt;
  &lt;facilityDirectory/&gt;
  &lt;providerDirectory/&gt;
&lt;/CSD&gt;
</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:delete_duplicate"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:delete_duplicate</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Deletes duplicate record reference.  This is done by removing a &lt;csd:otherID/&gt; element on the duplicate record that  references the master record.  
    
    This a &lt;csd:otherID/&gt; is characterized as follows:
    
      The @assigningAuthorityName attribute will be the fixed valueurn:openhie.org:openinfoman attribute of the master record      
      The @code attribute will be the fixed value 'duplicate' to indicate this is for marking a duplicate
      The text() value will be the entity ID used to reference to the master record for the entity
    

    A Care Services Request can be submitted to delete the mark that the record as duplicate with the following request parameters:
    
      &lt;masterEntity/&gt; should have attribute @entityID which contains the entity ID of the master record that the duplicate record should refer to
      &lt;duplicateEntity/&gt; should have attribute @entityID which contains the entity ID of the  duplicate record
    

  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_lsc = "https://github.com/openhie/openinfoman/csd_lsc";
import module namespace csd_dm = "https://github.com/openhie/openinfoman/csd_dm";
import module namespace csd_webconf =  "https://github.com/openhie/openinfoman/csd_webconf";
declare namespace csd  =  "urn:ihe:iti:csd:2013";

declare variable $careServicesRequest as item() external;

let $doc_name := string($careServicesRequest/@resource)
let $doc := csd_dm:open_document($doc_name)

let $masterID := $careServicesRequest/masterEntity/@entityID

let $dupID := $careServicesRequest/duplicateEntity/@entityID
let $dupEntity :=  if (exists($dupID)) then (/csd:CSD/*/*[@entityID = $dupID])[1] else ()


let $dupRef := $dupEntity/csd:otherID[@assigningAuthorityName='urn:openhie.org:openinfoman' and @code='duplicate' and text()=$masterID]

return 
  if (exists($dupRef))
  then delete node $dupRef
  else ()
</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:delete_potential_duplicate"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:delete_potential_duplicate</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Deletes potential duplicate record reference.  This is done by removing a &lt;csd:otherID/&gt; element on the potetnial duplicate record which references the master record.  
    
    This a &lt;csd:otherID/&gt; is characterized as follows:
    
      The @assigningAuthorityName attribute will be the fixed valueurn:openhie.org:openinfoman attribute of the master record      
      The @code attribute will be the fixed value 'duplicate' to indicate this is for marking a duplicate
      The text() value will be the entity ID used to reference to the master record for the entity
    

    A Care Services Request can be submitted to delete the mark that the record as potential duplicate with the following request parameters:
    
      &lt;masterEntity/&gt; should have attribute @entityID which contains the entity ID of the master record that the duplicate record should refer to
      &lt;duplicateEntity/&gt; should have attribute @entityID which contains the entity ID of the  duplicate record
    

  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_lsc = "https://github.com/openhie/openinfoman/csd_lsc";
import module namespace csd_dm = "https://github.com/openhie/openinfoman/csd_dm";
import module namespace csd_webconf =  "https://github.com/openhie/openinfoman/csd_webconf";
declare namespace csd  =  "urn:ihe:iti:csd:2013";

declare variable $careServicesRequest as item() external;

let $doc_name := string($careServicesRequest/@resource)
let $doc := csd_dm:open_document($doc_name)

let $masterID := $careServicesRequest/masterEntity/@entityID

let $dupID := $careServicesRequest/duplicateEntity/@entityID
let $dupEntity :=  if (exists($dupID)) then (/csd:CSD/*/*[@entityID = $dupID])[1] else ()


let $dupRef := $dupEntity/csd:otherID[@assigningAuthorityName='urn:openhie.org:openinfoman' and @code='potential-duplicate' and text()=$masterID]

return 
  if (exists($dupRef))
  then delete node $dupRef
  else ()
</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:extract_hierachy"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:extract_hierachy</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Performs an organization hierarch extraction from a source document into the target document.  Any existing elements in the target document are overwritten by those from the source document(s).

    There are two required parameters:
    
      
	The document is indicated via &lt;document/%gt; element.    If  @resource attribute of the &lt;document/&gt; should be the name of a document available to OpenInfoMan.   Otherwise the content of the &lt;document/&gt; should be a valid CSD document.
      
    

    Under each  &lt;document/&gt; is the required elements:
    
      
	Aa &lt;csd:organization/&gt; element to indicate the part of the hiearchy that should be extracted.  
      
    
    Under each  &lt;document/&gt; are two optional elements:
    
      
	keepParents
	0..1 keepParents  element has integer attribute @value.  Defaults to 1 which means we keep the parents of the indicated organization when we extract.
      
      
	processFacilities
	0..1 processFacilities  element has integer attribute @value.  Defaults to 1 which means we also include the facilities associated to the organizations in the extracted hierarchy.
      
    


All parent nodes of the indicated organziation 
  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_lsc = "https://github.com/openhie/openinfoman/csd_lsc";
import module namespace csd_dm = "https://github.com/openhie/openinfoman/csd_dm";
import module namespace csd_webconf =  "https://github.com/openhie/openinfoman/csd_webconf";
import module namespace functx = "http://www.functx.com";
import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
declare namespace csd  =  "urn:ihe:iti:csd:2013";

declare variable $careServicesRequest as item() external;



let $dest_doc := /.
let $dest := $careServicesRequest/@resource


return for $doc in $careServicesRequest/documents/document
  let $name := $doc/@resource
  let $src_doc :=
    if (not (functx:all-whitespace($name)))
    then if (not ($name = $dest)) then csd_dm:open_document($name) else ()
    else $doc/csd:CSD
  let $req_org_id :=  $doc/csd:organization/@entityID 

    
  let $processFacilities := 
    if (exists($doc/processFacilities/@value))
    then ($doc/processFacilities/@value = 1)
    else true()
  let $keepParents := 
    if (exists($doc/keepParents/@value))
    then ($doc/keepParents/@value = 1)
    else true()
    
  let $all_orgs := $src_doc/csd:CSD/csd:organizationDirectory/csd:organization
  let $org := $all_orgs[@entityID = $req_org_id]

  let $orgs := 
    if (not(exists($org)))
    then () (: nothing to extract:) 
    else
      (
	if ($keepParents)
	then csd_bl:get_parent_orgs($all_orgs,$org)
	else ()
	,
	$org
	,
	csd_bl:get_child_orgs($all_orgs,$org)
      )

  let $facs := 
    if (not ($processFacilities) )
    then ()
    else 
      for $org in $orgs
      return  $src_doc/csd:CSD/csd:facilityDirectory/csd:facility[./csd:organizations/csd:organization/@entityID = $org/@entityID]
	


  return
    (
      csd_lsc:update_directory($dest_doc/csd:CSD/csd:organizationDirectory,$orgs)
      ,csd_lsc:update_directory($dest_doc/csd:CSD/csd:facilityDirectory,$facs)
    )



</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:facility_create"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:facility_create</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source">Create or update a facility entity.   Request parameters should be one or more CSD facility entities</span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
(:
import module namespace random = "http://basex.org/modules/random";
:)
import module namespace csd_blu = "https://github.com/openhie/openinfoman/csd_blu";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;

(: 
   The query will be executed against the root element of the CSD document.
   
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 
for $fac in $careServicesRequest/facility
  let $existing := if (exists($fac/@entityID)) then csd_bl:filter_by_primary_id(/CSD/facilityDirectory/*,$fac) else ()
  return
    if (exists($existing)) 
    then replace node $existing with $fac
    else insert node $fac into /CSD/facilityDirectory
</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:mark_duplicate"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:mark_duplicate</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Marks a record as a duplicate with another record.  This is done by adding a &lt;csd:otherID/&gt; element to the record that is duplicate which references the master record.  
    
    This a &lt;csd:otherID/&gt; is characterized as follows:
    
      The @assigningAuthorityName attribute will be the fixed valueurn:openhie.org:openinfoman attribute of the master record      
      The @code attribute will be the fixed value 'duplicate' to indicate this is for marking a duplicate
      The text() value will be the entity ID used to reference to the master record for the entity
    

    A Care Services Request can be submitted to mark the record as duplicate with the following request parameters:
    
      &lt;masterEntity/&gt; should have attribute @entityID which contains the entity ID of the master record that the duplicate record should refer to
      &lt;duplicateEntity/&gt; should have attribute @entityID which contains the entity ID of the  duplicate record
    

  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_lsc = "https://github.com/openhie/openinfoman/csd_lsc";
import module namespace csd_dm = "https://github.com/openhie/openinfoman/csd_dm";
import module namespace csd_webconf =  "https://github.com/openhie/openinfoman/csd_webconf";
declare namespace csd  =  "urn:ihe:iti:csd:2013";

declare variable $careServicesRequest as item() external;

let $doc_name := string($careServicesRequest/@resource)
let $doc := csd_dm:open_document($doc_name)

let $masterID := $careServicesRequest/masterEntity/@entityID
let $masterEntity := if (exists($masterID)) then  (/csd:CSD/*/*[@entityID = $masterID])[1] else ()

let $dupID := $careServicesRequest/duplicateEntity/@entityID
let $dupEntity :=  if (exists($dupID)) then (/csd:CSD/*/*[@entityID = $dupID])[1] else ()


let $masterRef := &lt;csd:otherID assigningAuthorityName='urn:openhie.org:openinfoman' code='duplicate'&gt;{string($masterID)}&lt;/csd:otherID&gt;

return 
  if (not(exists($masterEntity)) or not( exists($dupEntity)))
  then ()
  else 
    let $existingRef := ($dupEntity/csd:otherID[@assigningAuthorityName = 'urn:openhie.org:openinfoman' and @code='duplicate'])[1]
    return 
      (
	if (exists($existingRef))
	then (replace node $existingRef with $masterRef)
	else (insert node $masterRef before ($dupEntity/*)[1])
      ,
        for $entity in /csd:CSD/*/*[./csd:otherID[@assigningAuthorityName='urn:openhie.org:openinfoman' and @code='duplicate' and ./text()=$dupID]]
	let $e_existingRef := ($entity/csd:otherID[@assigningAuthorityName='urn:openhie.org:openinfoman' and @code='duplicate' and  ./text()=$dupID])[1]
	return 
	  if (not($e_existingRef = $existingRef)  )
	  then replace node $e_existingRef with $masterRef
	  else () (:avoid double replacelement in edge case in which a record is marked as duplicate to itself:)
     )


</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:mark_potential_duplicate"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:mark_potential_duplicate</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Marks a record as a potential duplicate with another record.  This is done by adding a &lt;csd:otherID/&gt; element to the record that is the potential duplicate which references the master record.  
    
    This a &lt;csd:otherID/&gt; is characterized as follows:
    
      The @assigningAuthorityName attribute will be the fixed valueurn:openhie.org:openinfoman attribute of the master record      
      The @code attribute will be the fixed value 'potential-duplicate' to indicate this is for marking a potential duplicate
      The text() value will be the entity ID used to reference to the master record for the entity
    

    A Care Services Request can be submitted to mark the record as potential duplicate with the following request parameters:
    
      &lt;masterEntity/&gt; should have attribute @entityID which contains the entity ID of the master record that the potential duplicate record should refer to
      &lt;duplicateEntity/&gt; should have attribute @entityID which contains the entity ID of the  duplicate record
    

  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_lsc = "https://github.com/openhie/openinfoman/csd_lsc";
import module namespace csd_dm = "https://github.com/openhie/openinfoman/csd_dm";
import module namespace csd_webconf =  "https://github.com/openhie/openinfoman/csd_webconf";
declare namespace csd  =  "urn:ihe:iti:csd:2013";

declare variable $careServicesRequest as item() external;

let $doc_name := string($careServicesRequest/@resource)
let $doc := csd_dm:open_document($doc_name)

let $masterID := $careServicesRequest/masterEntity/@entityID
let $masterEntity := if (exists($masterID)) then  (/csd:CSD/*/*[@entityID = $masterID])[1] else ()

let $dupID := $careServicesRequest/duplicateEntity/@entityID
let $dupEntity :=  if (exists($dupID)) then (/csd:CSD/*/*[@entityID = $dupID])[1] else ()


let $masterRef := &lt;csd:otherID assigningAuthorityName='urn:openhie.org:openinfoman' code='potential-duplicate'&gt;{string($masterID)}&lt;/csd:otherID&gt;

return 
  if (not(exists($masterEntity)) or not( exists($dupEntity)))
  then ()
  else 
    let $existingRef := ($dupEntity/csd:otherID[@assigningAuthorityName = 'urn:openhie.org:openinfoman' and @code='potential-duplicate' and text() = $masterID])[1]
    return 
      (
	if (exists($existingRef))
	then (replace node $existingRef with $masterRef)
	else (insert node $masterRef before ($dupEntity/*)[1])
      ,
        for $entity in /csd:CSD/*/*[./csd:otherID[@assigningAuthorityName='urn:openhie.org:openinfoman' and @code='potential-duplicate' and ./text()=$dupID]]
	let $e_existingRef := ($entity/csd:otherID[@assigningAuthorityName='urn:openhie.org:openinfoman' and @code='potential-duplicate' and  ./text()=$dupID])[1]
	return (replace node $e_existingRef with $masterRef)
     )


</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:identifier_merge"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:identifier_merge</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Performs a merge from the indicated source document(s) into the target document.   Any entities in the target document are overwritten by the corresponding entity in the source document except that &lt;csd:otherID/&gt; elements are preserved.

    Documents are indicated via &lt;document/%gt; elements under the top-level &lt;documents/&gt; element.   
    The  @resource attribute of the &lt;document/&gt; should be the name of a document available to OpenInfoMan.   Otherwise the content of the &lt;document/&gt; should be a valid CSD document.


    The following optional elements are allowed under each &lt;document/%gt; element :
    
      insertNew 0..1 insertNew has integer attribute @value. Defaults to 1 which means we insert any new entities from the source documents if they are not already a part of the destination document
    

  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_lsc = "https://github.com/openhie/openinfoman/csd_lsc";
import module namespace csd_dm = "https://github.com/openhie/openinfoman/csd_dm";
import module namespace csd_webconf =  "https://github.com/openhie/openinfoman/csd_webconf";
import module namespace functx = "http://www.functx.com";
declare namespace csd  =  "urn:ihe:iti:csd:2013";

declare variable $careServicesRequest as item() external;



let $dest_doc := /.
let $dest := $careServicesRequest/@resource
for $doc in $careServicesRequest/documents/document
  let $insertNew := 
    if (exists($doc/insertNew/@value))
    then ($doc/insertNew/@value = 1)
    else true()

  let $name := string($doc/@resource)
  let $src_doc :=
    if (not (functx:all-whitespace($name)))
    then if (not ($name = $dest)) then csd_dm:open_document( $name) else ()
    else $doc
  return 
    (
    let $src_dir := $src_doc/csd:CSD/csd:organizationDirectory
    let $dest_dir := $dest_doc/csd:CSD/csd:organizationDirectory
    return
      for $e in $src_dir/csd:organization 
      let $existing := $dest_dir/csd:organization[@entityID = $e/@entityID]
      return 
	if (exists($existing)) 
        then
          let $new := 
	    &lt;csd:organization entityID="{$e/@entityID}"&gt;
	      {$existing/csd:otherID}  
	      {$e/*}
	    &lt;/csd:organization&gt;
	  return replace node $existing with $new 
        else if ($insertNew) then insert node $e into $dest_dir else ()
    ,
    let $src_dir := $src_doc/csd:CSD/csd:providerDirectory
    let $dest_dir := $dest_doc/csd:CSD/csd:providerDirectory
    return
      for $e in $src_dir/csd:provider 
      let $existing := $dest_dir/csd:provider[@entityID = $e/@entityID]
      return 
	if (exists($existing)) 
	then
          let $new := 
	    &lt;csd:provider entityID="{$e/@entityID}"&gt;
	      {$existing/csd:otherID}  
	      {$e/*}
	    &lt;/csd:provider&gt;
	  return replace node $existing with $new 
        else if ($insertNew) then insert node $e into $dest_dir else ()
    ,
    let $src_dir := $src_doc/csd:CSD/csd:serviceDirectory
    let $dest_dir := $dest_doc/csd:CSD/csd:serviceDirectory
    return
      for $e in $src_dir/csd:service 
      let $existing := $dest_dir/csd:service[@entityID = $e/@entityID]
      return 
	if (exists($existing)) 
	then
          let $new := 
	    &lt;csd:service entityID="{$e/@entityID}"&gt;
	      {$existing/csd:otherID}  
	      {$e/*}
	    &lt;/csd:service&gt;
	  return replace node $existing with $new 
        else if ($insertNew) then insert node $e into $dest_dir else ()
    ,
    let $src_dir := $src_doc/csd:CSD/csd:facilityDirectory
    let $dest_dir := $dest_doc/csd:CSD/csd:facilityDirectory
    return
      for $e in $src_dir/csd:facility 
      let $existing := $dest_dir/csd:facility[@entityID = $e/@entityID]
      return 
	if (exists($existing)) 
	then
          let $new := 
	    &lt;csd:facility entityID="{$e/@entityID}"&gt;
	      {$existing/csd:otherID}  
	      {$e/*}
	    &lt;/csd:facility&gt;
	  return replace node $existing with $new 
        else if ($insertNew) then insert node $e into $dest_dir else ()

    )




</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:organization_create"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:organization_create</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source">Create or update a organization entity.   Request parameters should be one or more CSD organization entities</span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
(:
import module namespace random = "http://basex.org/modules/random";
:)
import module namespace csd_blu = "https://github.com/openhie/openinfoman/csd_blu";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;

(: 
   The query will be executed against the root element of the CSD document.
   
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 
for $org in $careServicesRequest/organization
  let $existing := if (exists($org/@entityID)) then csd_bl:filter_by_primary_id(/CSD/organizationDirectory/*,$org) else ()
  return
    if (exists($existing)) 
    then replace node $existing with $org
    else insert node $org into /CSD/organizationDirectory
</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:provider_create"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:provider_create</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source">Create or update a provider entity.   Request parameters should be one or more CSD provider entities</span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
(:
import module namespace random = "http://basex.org/modules/random";
:)
import module namespace csd_blu = "https://github.com/openhie/openinfoman/csd_blu";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;

(: 
   The query will be executed against the root element of the CSD document.
   
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 
for $prov in $careServicesRequest/provider
  let $existing := if (exists($prov/@entityID)) then csd_bl:filter_by_primary_id(/CSD/providerDirectory/*,$prov) else ()
  return
    if (exists($existing)) 
    then replace node $existing with $prov
    else insert node $prov into /CSD/providerDirectory
</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:service_create"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:service_create</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source">Create or update a service entity.   Request parameters should be one or more CSD service entities</span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_bl = "https://github.com/openhie/openinfoman/csd_bl";
(:
import module namespace random = "http://basex.org/modules/random";
:)
import module namespace csd_blu = "https://github.com/openhie/openinfoman/csd_blu";
declare default element  namespace   "urn:ihe:iti:csd:2013";
declare variable $careServicesRequest as item() external;

(: 
   The query will be executed against the root element of the CSD document.
   
   The dynamic context of this query has $careServicesRequest set to contain any of the search 
   and limit paramaters as sent by the Service Finder
:) 
for $srvc in $careServicesRequest/service
  let $existing := if (exists($srvc/@entityID)) then csd_bl:filter_by_primary_id(/CSD/serviceDirectory/*,$srvc) else ()
  return
    if (exists($existing)) 
    then replace node $existing with $srvc
    else insert node $srvc into /CSD/serviceDirectory
</pre></span>
      </div>
    </div>
    <a id="urn:openhie.org:openinfoman:simple_merge"/>
    <div class="function">
      <div class="callout">
        <span class="attribute">Content-Type: 
        text/xml<br/>
	URN: urn:openhie.org:openinfoman:simple_merge</span>
        <h2>Description</h2>
        <br/>
        <br/>
        <span class="source"> 
    Performs a simple merge from the indicated source document(s) into the target document.  

    Documents are indicated via &lt;document/%gt; elements under the top-level &lt;documents/&gt; element.   
    If  @resource attribute of the &lt;document/&gt; should be the name of a document available to OpenInfoMan.   Otherwise the content of the &lt;document/&gt; should be a valid CSD document.

    The following optional elements are allowed:
    
      overwriteExisting 0..1 overwriteExisting has integer attribute @value. Defaults to 1 which aany existing elements in the target document are overwritten by those from the source document(s).
    

  </span>
        <h2>Definition            </h2>
        <span class="source">Source: 
	<pre>import module namespace csd_lsc = "https://github.com/openhie/openinfoman/csd_lsc";
import module namespace csd_dm = "https://github.com/openhie/openinfoman/csd_dm";
import module namespace csd_webconf =  "https://github.com/openhie/openinfoman/csd_webconf";
import module namespace functx = "http://www.functx.com";
declare namespace csd  =  "urn:ihe:iti:csd:2013";

declare variable $careServicesRequest as item() external;


let $overwriteExisting := 
  if (exists($careServicesRequest/overwriteExisting/@value))
  then ($careServicesRequest/overwriteExisting/@value = 1)
  else true()


let $dest_doc := /.
let $dest := $careServicesRequest/@resource

for $doc  in $careServicesRequest/documents/document
  let $name := $doc/@resource
  let $src_doc :=
    if (not (functx:all-whitespace($name)))
    then if (not ($name = $dest)) then csd_dm:open_document($name) else ()
    else $doc
  return  
    csd_lsc:refresh_doc($dest_doc, $src_doc,$overwriteExisting) 



</pre></span>
      </div>
    </div>
  </body>
</html>
