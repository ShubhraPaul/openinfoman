<?xml version="1.0" encoding="UTF-8"?>
<csd:careServicesFunction 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xmlns:csd="urn:ihe:iti:csd:2013"
  xmlns:xforms="http://www.w3.org/2002/xforms"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:soap="http://www.w3.org/2003/05/soap-envelope"
  xmlns:wsa="http://www.w3.org/2005/08/addressing" 
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  urn="urn:ihe:iti:csd:2014:stored-function:provider-search">
  <csd:description>
    <p> Performs a search for all providers by name, coded type, address or ID. </p>
    <p> The result set consists of all providers matching the <i>search parameters</i> ( <b>id</b>,
        <b>otherID</b>, <b>commonName</b>,<b>codedType</b> and <b>address</b> ). </p>
    <p> The results set may be further restricted according to the <i>limit parameters</i>
        (<b>start</b>, <b>max</b>, <b>record/@status</b> and <b>record/@updated</b>). An ordering of
      the result set is not specified. </p>
    <p>
      <h2>Response</h2> Results are returned as a valid CSD document with a root document element of
      &lt;CSD/&gt;. The results set is contained entirely within the &lt;providerDirectory/&gt;
      element and consists of the full content of the &lt;provider/&gt; elements of matching
      providers as maintained by the Care Services InfoManager. </p>
    <h2>Parameters</h2> Query Parameters are defined as the content of following elements: <ul>
      <li> &lt;id/&gt; <i>csd:uniqueID</i>: (optional) If present and the @entityID attribute contains a
        non-empty value, it is a ID which uniquely identifies a provider. This is an exact match. </li>
      <li> &lt;otherID/&gt; <i>csd:otherID</i>: (optional) If present and the
        @assigningAuthorityName attribute contains a non-empty value, then the result set is
        restricted to only those providers which have a &lt;otherID/&gt; with the given
        assigingAuthorityName and @code </li> <li>&lt;commonName/&gt; <i>xsd:string</i>: (optional)
        If present and contains a non-empty value, then the result set should be restricted to those
        providers which have a &lt;demographic/name/commonName/&gt; containing this value. Case
        insensitive.</li>
      <li>&lt;codedType/&gt; <i>csd:codedtype</i>: If present and contains a non-empty value the
        result set should be restricted to those providers whose &lt;codeType/@code&gt; equals this
        value for the coding schema specified by the @codingScheme attribute. Case insensitive. </li>
      <li> &lt;address/&gt; <i>csd:address</i>: (optional) Contains of any-number of child
        &lt;addressLine/&gt; elements as follows: <ul>
          <li>Text content <i>xsd:string</i>: (optional) If present and contains a non-empty value,
            then the results set should be restricted to those providers whose have an
            &lt;addressLine/&gt; with specified @component containing this value exactly. Case
            insensitive. </li>
          <li>@component <i>xsd:string</i> : (Required attribute) The component of the address we
            are searching. Case insensitive.</li>
        </ul>
      </li>
      <li>&lt;start/&gt; <i> xsd:int</i>: (optional) The starting index for results returned.
        Defaults to 1, which indexes the first provider matching the search parameters</li>
      <li>&lt;max/&gt; <i> xsd:int</i>: (optional) The maximum number of results returned. A value
        of less than zero implies no maximum.</li>
      <li> &lt;record/&gt; <i> csd:record </i>: (optional) A child element to limit results
        according to <ul>
          <li>@status <i>xsd:string</i>: (optional) If present and contains a non-empty value, the
            result set should be restricted to those providers whose record/@status equals this
            value. Case insensitive.</li>
          <li>@updated <i>xsd:dateTime</i>: (optional) If present and contains a non-empty value,
            the result set should be restricted to those providers whose record/@updated is at least
            the given value.</li>
        </ul>
      </li>
    </ul>
    <h2>Example Request</h2>
    <pre>
         &lt;careServicesRequest&gt;
           &lt;function urn='urn:ihe:iti:csd:2014:stored-function:service-search'&gt;
               &lt;codedType code="2221" codingScheme="ISCO-08" /&lt;
               &lt;address&gt;
                 &lt;addressLine component='city'&gt;Kigali&lt;/addressLine&gt;
	       &lt;/address&gt;
               &lt;max&gt;5&lt;/max&gt;
           &lt;/function&gt;
         &lt;/careServicesRequest&gt;         
      </pre>
  </csd:description>
  <csd:definition ><xi:include parse='text' href='provider_search.xq'/></csd:definition>

  <xforms:model id='urn:ihe:iti:csd:2014:stored-function:provider-search'>
    <xforms:instance id='soap-request'>
      <soap:Envelope >
	<soap:Header>
	  <wsa:Action soap:mustUnderstand="1">urn:ihe:iti:csd:2013:GetCareServicesRequest</wsa:Action>
          <wsa:MessageID/>
          <wsa:ReplyTo soap:mustUnderstand="1">
            <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>
          </wsa:ReplyTo>
          <wsa:To soap:mustUnderstand="1">{$LOCATION}</wsa:To>
	</soap:Header>
	<soap:Body>
	  <csd:careServicesRequest>
	    <csd:function urn="urn:ihe:iti:csd:2014:stored-function:provider-search">
     	      <csd:requestParams>
		<csd:id/>
		<csd:otherID/>
		<csd:commonName/>
		<csd:codedType/>
		<csd:address/>
		<csd:start/>
		<csd:max/>
		<csd:record/>
	      </csd:requestParams>
            </csd:function>
	  </csd:careServicesRequest>         
	</soap:Body>
      </soap:Envelope>
    </xforms:instance>

    <xforms:instance id='http-post-request'>
      <csd:requestParams>
	<csd:id/>
	<csd:otherID/>
	<csd:commonName/>
	<csd:codedType/>
	<csd:address/>
	<csd:start/>
	<csd:max/>
	<csd:record/>
      </csd:requestParams>
    </xforms:instance>

    <xforms:instance id="soap-response" >
      <soap:Envelope>
	<csd:careServicesResponse/>
      </soap:Envelope>
    </xforms:instance>
    <xforms:instance id="http-post-response" >
      <csd:CSD/>
    </xforms:instance>

    <xforms:submission id='soap-submission' method="post" mediatype="text/xml"
		       replace="instance" instance="soap-response" 
		       targetref="soap:Envelope/soap:Body/csd:careServicesResponse/csd:result/csd:CSD"
		       resource="{$LOCATION}" />		       

    <xforms:submission id='http-post-submission' method="post" mediatype="text/xml"
		       replace="instance" instance="http-post-response" 
		       targetref="csd:CSD"
		       resource="{$LOCATION}/urn:ihe:iti:csd:2014:stored-function:provider-search" />

    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope:soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:id" 
	type="csd:uniqueID" />
    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:otherID" 
	type="csd:otherID" />
    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:commonName" 
	type="xs:string" />
    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:codedType" 
	type="csd:codedtype" />
    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:address" 
	type="csd:address" />
    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:start" 
	type="xs:int" />
    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:max" 
	type="xs:int" />
    <xforms:bind 
	nodeset="instance('soap-request')/soap:Envelope/soap:Header/soap:Body/csd:careServicesRequest/csd:function/csd:requestParams/csd:record" 
	type="csd:record" />


    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:id" type="csd:uniqueID" />
    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:otherID" type="csd:otherID" />
    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:commonName" type="xs:string" />
    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:codedType" type="csd:codedtype" />
    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:address" type="csd:address" />
    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:start" type="xs:int" />
    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:max" type="xs:int" />
    <xforms:bind nodeset="instance('http-post-request')/csd:requestParams/csd:record" type="csd:record" />

    <xforms:bind nodeset="instance('http-post-response')/csd:CSD" type="csd:CSD" />

    <xforms:bind nodeset="instance('soap-response')/soap:Envelope/soap:Body/csd:careServicesResponse/csd:result/csd:CSD" type="csd:CSD" />

  </xforms:model>
</csd:careServicesFunction>
